// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// User and Authentication Models
model User {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String?
  firstName   String
  lastName    String
  role        UserRole
  isActive    Boolean   @default(true)
  avatar      String?
  phone       String?
  address     String?
  dateOfBirth DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  doctorProfile      Doctor?
  patientProfile     Patient?
  staffProfile       Staff?
  appointments       Appointment[]
  collectedOrders    LabOrder[]       @relation("CollectedOrders")
  processedOrders    LabOrder[]       @relation("ProcessedOrders")
  reviewedOrders     LabOrder[]       @relation("ReviewedOrders")
  technicianResults  LabResult[]      @relation("TechnicianResults")
  verifiedResults    LabResult[]      @relation("VerifiedResults")
  labWorkflows       LabWorkflow[]
  headOfDepartments  LabDepartment[]  @relation("DepartmentHead")
  invoices           Invoice[]
  auditLogs          AuditLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  DOCTOR
  NURSE
  RECEPTIONIST
  LAB_TECHNICIAN
  PHARMACIST
  PATIENT
}

// Patient Management Models
model Patient {
  id                           String   @id @default(cuid())
  patientId                    String   @unique
  firstName                    String
  lastName                     String
  email                        String?
  phone                        String
  dateOfBirth                  DateTime
  gender                       Gender
  address                      String
  city                         String   @default("")
  state                        String   @default("")
  zipCode                      String   @default("")
  emergencyContactName         String   @default("")
  emergencyContactPhone        String   @default("")
  emergencyContactRelationship String   @default("")
  bloodGroup                   String?
  allergies                    String?
  chronicConditions            String?
  currentMedications           String?
  insuranceProvider            String?
  insurancePolicyNumber        String?
  
  // Additional OPD registration fields
  guardianName                 String?
  guardianRelation             String?
  occupation                   String?
  idProofType                  String?
  idProofNumber                String?
  patientType                  PatientType @default(NEW)
  isActive                     Boolean  @default(true)
  avatar                       String?
  notes                        String?
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  // Optional account link for patient portal access
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Relations
  appointments   Appointment[]
  medicalRecords MedicalRecord[]
  prescriptions  Prescription[]
  labOrders      LabOrder[]
  invoices       Invoice[]
  vitalSigns     VitalSigns[]
  
  // OPD & IPD Relations
  opdVisits      OPDVisit[]
  admissions     Admission[]
  documents      Document[]

  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum PatientType {
  NEW
  RETURNING
}

model MedicalRecord {
  id        String   @id @default(cuid())
  patientId String
  diagnosis String
  treatment String
  notes     String?
  date      DateTime
  doctorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor  @relation(fields: [doctorId], references: [id])

  @@map("medical_records")
}

model VitalSigns {
  id               String   @id @default(cuid())
  patientId        String
  bloodPressure    String
  heartRate        Int
  temperature      Float
  respiratoryRate  Int
  oxygenSaturation Int
  weight           Float?
  height           Float?
  recordedAt       DateTime
  recordedBy       String
  createdAt        DateTime @default(now())

  // Relations
  patient Patient @relation(fields: [patientId], references: [id])

  @@map("vital_signs")
}

// Doctor and Appointment Models
model Doctor {
  id              String    @id @default(cuid())
  doctorId        String    @unique
  firstName       String
  lastName        String
  email           String    @unique
  phone           String
  specialization  String
  licenseNumber   String    @unique
  experience      Int
  qualification   String
  consultationFee Float
  dateOfBirth     DateTime?
  gender          Gender?
  address         String?
  isAvailable     Boolean   @default(true)
  isActive        Boolean   @default(true)
  opdIpdAvailability String @default("both") // "opd", "ipd", "both"
  avatar          String?
  workingHours    String // JSON string for working hours
  notes           String?
  // Additional fields from registration form (add as needed):
  city            String?
  state           String?
  zipCode         String?
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelationship String?
  bloodGroup      String?
  joiningDate     DateTime?
  departmentId    String? // Primary department reference
  // Remove photo/pdf fields if any (none present)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Optional account link for doctor portal access
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Relations
  appointments   Appointment[]
  medicalRecords MedicalRecord[]
  prescriptions  Prescription[]     @relation("DoctorPrescriptions")
  departments    DoctorDepartment[]
  schedules      Schedule[]
  primaryDepartment Department?     @relation("PrimaryDepartment", fields: [departmentId], references: [id])
  headOfDepartments Department[]    @relation("DepartmentHead")
  
  // OPD & IPD Relations
  opdVisits      OPDVisit[]
  opdPrescriptions OPDPrescription[]
  admissions     Admission[]
  treatments     Treatment[]
  discharges     Discharge[]

  // Lab Relations
  labOrders      LabOrder[]

  @@map("doctors")
}

// Nurse/Staff Model
model Staff {
  id            String    @id @default(cuid())
  staffId       String    @unique
  firstName     String
  lastName      String
  email         String    @unique
  phone         String
  role          StaffRole
  department    String?
  qualification String?
  dateOfBirth   DateTime?
  gender        Gender?
  address       String?
  isActive      Boolean   @default(true)
  avatar        String?
  joiningDate   DateTime  @default(now())
  salary        Float?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Optional account link for staff portal access
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  @@map("staff")
}

enum StaffRole {
  NURSE
  LAB_TECHNICIAN
  PHARMACIST
  RECEPTIONIST
  ADMIN_STAFF
  OTHER
}

model Appointment {
  id          String            @id @default(cuid())
  patientId   String
  doctorId    String
  date        DateTime
  startTime   String
  endTime     String
  type        AppointmentType
  status      AppointmentStatus @default(SCHEDULED)
  reason      String
  notes       String?
  createdById String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  patient   Patient @relation(fields: [patientId], references: [id])
  doctor    Doctor  @relation(fields: [doctorId], references: [id])
  createdBy User    @relation(fields: [createdById], references: [id])

  @@map("appointments")
}

enum AppointmentType {
  CONSULTATION
  FOLLOW_UP
  EMERGENCY
  ROUTINE_CHECKUP
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// Billing Models
model Invoice {
  id          String        @id @default(cuid())
  invoiceId   String        @unique
  patientId   String
  amount      Float
  tax         Float         @default(0)
  discount    Float         @default(0)
  totalAmount Float
  status      InvoiceStatus @default(PENDING)
  dueDate     DateTime
  issuedDate  DateTime      @default(now())
  paidDate    DateTime?
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  patient   Patient       @relation(fields: [patientId], references: [id])
  createdBy User          @relation(fields: [createdById], references: [id])
  items     BillingItem[]
  payments  Payment[]

  @@map("invoices")
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model BillingItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  category    String
  createdAt   DateTime @default(now())

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@map("billing_items")
}

model Payment {
  id            String        @id @default(cuid())
  invoiceId     String
  amount        Float
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@map("payments")
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  INSURANCE
  ONLINE
  TPA  // Third Party Administrator
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Laboratory Models
model LabTest {
  id           String   @id @default(cuid())
  name         String
  code         String   @unique
  category     String
  department   String   // Hematology, Biochemistry, etc.
  price        Float
  normalRange  String?
  unit         String?
  description  String?
  duration     String?  // "2-4 hours", "1-2 days"
  methodology  String?  // Test methodology
  sampleType   String?  // Blood, Urine, Stool, etc.
  sampleVolume String?  // Required sample volume
  fasting      Boolean  @default(false) // Fasting required
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  departmentRef LabDepartment? @relation(fields: [department], references: [code])
  orders        LabOrder[]
  results       LabResult[]
  templates     LabTemplate[]

  @@map("lab_tests")
}

model LabOrder {
  id               String         @id @default(cuid())
  orderId          String         @unique
  patientId        String
  doctorId         String
  testIds          String         // JSON array of test IDs
  status           LabOrderStatus @default(PENDING)
  priority         Priority       @default(NORMAL)
  notes            String?
  clinicalNotes    String?        // Clinical observations and requirements
  requestedBy      String?        // Name of the requesting doctor/staff
  orderedAt        DateTime       @default(now())
  collectedAt      DateTime?
  processingAt     DateTime?
  completedAt      DateTime?
  totalCost        Float?
  collectedBy      String?        // Staff who collected sample
  processedBy      String?        // Lab technician assigned
  reviewedBy       String?        // Doctor who reviewed
  sampleCondition  String?        // Sample quality notes
  reportGenerated  Boolean        @default(false)
  reportContent    String?        // Final report text
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  patient   Patient       @relation(fields: [patientId], references: [id])
  doctor    Doctor        @relation(fields: [doctorId], references: [id])
  collector User?         @relation("CollectedOrders", fields: [collectedBy], references: [id])
  processor User?         @relation("ProcessedOrders", fields: [processedBy], references: [id])
  reviewer  User?         @relation("ReviewedOrders", fields: [reviewedBy], references: [id])
  tests     LabTest[]
  results   LabResult[]
  workflows LabWorkflow[]

  @@map("lab_orders")
}

enum LabOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model LabResult {
  id             String    @id @default(cuid())
  orderId        String
  testId         String
  value          String
  unit           String?
  normalRange    String?
  status         String    // NORMAL, ABNORMAL, CRITICAL
  notes          String?
  technician     String    // Lab technician who performed test
  verifiedBy     String?   // Doctor who verified result
  verifiedAt     DateTime?
  interpretation String?   // Clinical interpretation
  flagged        Boolean   @default(false) // Critical result flag
  method         String?   // Testing method used
  instrument     String?   // Instrument/analyzer used
  testedAt       DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  order          LabOrder @relation(fields: [orderId], references: [id])
  test           LabTest  @relation(fields: [testId], references: [id])
  technicianUser User     @relation("TechnicianResults", fields: [technician], references: [id])
  verifier       User?    @relation("VerifiedResults", fields: [verifiedBy], references: [id])

  @@map("lab_results")
}

// Lab Department Model
model LabDepartment {
  id             String   @id @default(cuid())
  name           String   @unique
  code           String   @unique
  description    String?
  headTechnician String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  head  User?     @relation("DepartmentHead", fields: [headTechnician], references: [id])
  tests LabTest[]

  @@map("lab_departments")
}

// Lab Template Model (for common test panels)
model LabTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  testIds     String   // JSON array of test IDs
  totalCost   Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tests LabTest[]

  @@map("lab_templates")
}

// Lab Workflow Model (for audit trail)
model LabWorkflow {
  id        String   @id @default(cuid())
  orderId   String
  status    String
  changedBy String
  changedAt DateTime @default(now())
  notes     String?

  // Relations
  order LabOrder @relation(fields: [orderId], references: [id])
  user  User     @relation(fields: [changedBy], references: [id])

  @@map("lab_workflows")
}

// Pharmacy Models
model Medication {
  id                String   @id @default(cuid())
  name              String
  genericName       String?
  manufacturer      String
  dosageForm        String
  strength          String
  category          String
  description       String?
  sideEffects       String?
  contraindications String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  inventory     InventoryItem[]
  prescriptions PrescriptionItem[]

  @@map("medications")
}

model InventoryItem {
  id            String   @id @default(cuid())
  medicationId  String
  batchNumber   String
  quantity      Int
  unitPrice     Float
  expiryDate    DateTime
  supplier      String
  receivedDate  DateTime
  minStockLevel Int      @default(10)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  medication Medication @relation(fields: [medicationId], references: [id])

  @@map("inventory_items")
}

model Prescription {
  id        String             @id @default(cuid())
  patientId String
  doctorId  String
  date      DateTime           @default(now())
  status    PrescriptionStatus @default(PENDING)
  notes     String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  // Relations
  patient Patient            @relation(fields: [patientId], references: [id])
  doctor  Doctor             @relation("DoctorPrescriptions", fields: [doctorId], references: [id])
  items   PrescriptionItem[]

  @@map("prescriptions")
}

enum PrescriptionStatus {
  PENDING
  DISPENSED
  PARTIALLY_DISPENSED
  CANCELLED
}

model PrescriptionItem {
  id             String   @id @default(cuid())
  prescriptionId String
  medicationId   String
  dosage         String
  frequency      String
  duration       String
  quantity       Int
  instructions   String?
  createdAt      DateTime @default(now())

  // Relations
  prescription Prescription @relation(fields: [prescriptionId], references: [id])
  medication   Medication   @relation(fields: [medicationId], references: [id])

  @@map("prescription_items")
}

// Department and System Models
model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  headDoctorId String? // Reference to doctor who is HOD
  location    String?
  established String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  headDoctor Doctor?             @relation("DepartmentHead", fields: [headDoctorId], references: [id])
  doctors    DoctorDepartment[]
  primaryDoctors Doctor[]        @relation("PrimaryDepartment")
  
  // OPD & IPD Relations
  opdVisits  OPDVisit[]
  wards      Ward[]

  @@map("departments")
}

model DoctorDepartment {
  id           String   @id @default(cuid())
  doctorId     String
  departmentId String
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())

  // Relations
  doctor     Doctor     @relation(fields: [doctorId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])

  @@unique([doctorId, departmentId])
  @@map("doctor_departments")
}

model Schedule {
  id               String          @id @default(cuid())
  doctorId         String
  dayOfWeek        String          // e.g., "monday", "tuesday", etc.
  startTime        String          // e.g., "09:00"
  endTime          String          // e.g., "17:00"
  maxPatients      Int             @default(20)
  consultationType String          @default("OPD") // OPD, IPD, EMERGENCY, etc.
  status           ScheduleStatus  @default(ACTIVE)
  validFrom        DateTime        @default(now())
  validTo          DateTime?       // null means always valid
  breakStartTime   String?         // e.g., "13:00"
  breakEndTime     String?         // e.g., "14:00"
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Relations
  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([doctorId, dayOfWeek]) // One schedule per doctor per day
  @@map("schedules")
}

enum ScheduleStatus {
  ACTIVE
  INACTIVE
  TEMPORARY
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  resource  String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// ========================================
// OPD (Outpatient Department) Models
// ========================================

model OPDVisit {
  id                    String              @id @default(cuid())
  visitId               String              @unique
  patientId             String
  doctorId              String
  departmentId          String
  visitDate             DateTime            @default(now())
  visitTime             String
  visitType             VisitType           @default(OPD)
  appointmentMode       AppointmentMode     @default(WALK_IN)
  referralSource        ReferralSource      @default(SELF)
  referredBy            String?
  priority              VisitPriority       @default(NORMAL)
  status                VisitStatus         @default(PENDING)
  
  // Chief complaint and assessment
  chiefComplaint        String
  historyOfPresentIllness String?
  pastMedicalHistory    String?
  familyHistory         String?
  socialHistory         String?
  
  // Clinical examination
  generalExamination    String?
  systemicExamination   String?
  
  // Diagnosis and plan
  provisionalDiagnosis  String?
  finalDiagnosis        String?
  treatmentPlan         String?
  followUpDate          DateTime?
  followUpInstructions  String?
  
  // Investigation recommendations
  investigationRecommendations String?
  
  // Additional fields
  symptoms              String?
  notes                 String?
  isFollowUp            Boolean             @default(false)
  parentVisitId         String?
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  patient               Patient             @relation(fields: [patientId], references: [id])
  doctor                Doctor              @relation(fields: [doctorId], references: [id])
  department            Department          @relation(fields: [departmentId], references: [id])
  parentVisit           OPDVisit?           @relation("FollowUpVisits", fields: [parentVisitId], references: [id])
  followUpVisits        OPDVisit[]          @relation("FollowUpVisits")
  
  // Child relations
  vitals                OPDVitals[]
  prescriptions         OPDPrescription[]
  investigations        OPDInvestigation[]
  billing               OPDBilling?

  @@map("opd_visits")
}

model OPDVitals {
  id              String   @id @default(cuid())
  opdVisitId      String
  bloodPressure   String?
  heartRate       Int?
  temperature     Float?
  respiratoryRate Int?
  oxygenSaturation Int?
  weight          Float?
  height          Float?
  bmi             Float?
  recordedAt      DateTime @default(now())
  recordedBy      String
  notes           String?
  
  // Relations
  opdVisit        OPDVisit @relation(fields: [opdVisitId], references: [id], onDelete: Cascade)

  @@map("opd_vitals")
}

model OPDPrescription {
  id           String            @id @default(cuid())
  opdVisitId   String
  doctorId     String
  drugName     String            // Changed from medicineName to match frontend
  strength     String?           // Added strength field
  dosage       String            // This becomes dose in frontend
  frequency    String
  duration     String
  quantity     Int?
  route        MedicineRoute     @default(ORAL)
  instructions String?
  notes        String?           // Added notes field
  isGeneric    Boolean           @default(false)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  
  // Relations
  opdVisit     OPDVisit          @relation(fields: [opdVisitId], references: [id], onDelete: Cascade)
  doctor       Doctor            @relation(fields: [doctorId], references: [id])

  @@map("opd_prescriptions")
}

model OPDBilling {
  id                        String        @id @default(cuid())
  opdVisitId                String        @unique
  consultationFee           Float
  additionalCharges         Float         @default(0)
  discount                  Float         @default(0)
  tax                       Float         @default(0)
  totalAmount               Float
  paymentStatus             PaymentStatus @default(PENDING)
  paymentMethod             PaymentMethod?
  paidAmount                Float         @default(0)
  balanceAmount             Float         @default(0)
  transactionId             String?
  paymentDate               DateTime?
  notes                     String?
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  
  // Relations
  opdVisit                  OPDVisit      @relation(fields: [opdVisitId], references: [id], onDelete: Cascade)

  @@map("opd_billing")
}

model OPDInvestigation {
  id              String                @id @default(cuid())
  opdVisitId      String
  testName        String
  testType        InvestigationType     @default(LAB)
  urgency         InvestigationUrgency  @default(ROUTINE)
  instructions    String?
  orderedBy       String
  status          InvestigationStatus   @default(ORDERED)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  // Relations
  opdVisit        OPDVisit              @relation(fields: [opdVisitId], references: [id], onDelete: Cascade)

  @@map("opd_investigations")
}

// ========================================
// IPD (Inpatient Department) Models
// ========================================

model Ward {
  id            String   @id @default(cuid())
  wardNumber    String   @unique
  name          String
  type          WardType
  departmentId  String
  totalBeds     Int
  availableBeds Int
  floor         String?
  description   String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  department    Department @relation(fields: [departmentId], references: [id])
  beds          Bed[]

  @@map("wards")
}

model Bed {
  id            String   @id @default(cuid())
  bedNumber     String   @unique
  wardId        String
  isOccupied    Boolean  @default(false)
  bedType       String?  // ICU, General, Private, etc.
  dailyRate     Float?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  ward          Ward           @relation(fields: [wardId], references: [id])
  admissions    Admission[]
  fromTransfers BedTransfer[]  @relation("FromBedTransfer")
  toTransfers   BedTransfer[]  @relation("ToBedTransfer")

  @@map("beds")
}

model Admission {
  id                    String          @id @default(cuid())
  admissionId           String          @unique
  patientId             String
  doctorId              String
  bedId                 String
  admissionDate         DateTime        @default(now())
  admissionTime         String
  admissionType         AdmissionType
  category              String?         // Emergency, Planned, etc.
  referralSource        String?
  referredBy            String?
  
  // Clinical details
  chiefComplaint        String
  presentIllness        String?
  pastHistory           String?
  familyHistory         String?
  personalHistory       String?
  
  // Admission assessment
  generalCondition      String?
  consciousness         String?
  provisionalDiagnosis  String
  finalDiagnosis        String?
  treatmentPlan         String?
  
  // Status and discharge
  status                AdmissionStatus @default(STABLE)
  expectedDischargeDate DateTime?
  actualDischargeDate   DateTime?
  dischargeType         String?
  
  // Financial
  estimatedCost         Float?
  depositAmount         Float?
  
  // Additional fields
  notes                 String?
  emergencyContact      String?
  insuranceDetails      String?
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  patient               Patient         @relation(fields: [patientId], references: [id])
  doctor                Doctor          @relation(fields: [doctorId], references: [id])
  bed                   Bed             @relation(fields: [bedId], references: [id])
  
  // Child relations
  vitals                IPDVitals[]
  treatments            Treatment[]
  transfers             BedTransfer[]
  discharge             Discharge?

  @@map("admissions")
}

model IPDVitals {
  id                String   @id @default(cuid())
  admissionId       String
  bloodPressure     String?
  heartRate         Int?
  temperature       Float?
  respiratoryRate   Int?
  oxygenSaturation  Int?
  weight            Float?
  height            Float?
  bmi               Float?
  urinOutput        Float?
  fluidIntake       Float?
  painScale         Int?     // 1-10 scale
  recordedAt        DateTime @default(now())
  recordedBy        String
  shift             String?  // Morning, Evening, Night
  notes             String?
  
  // Relations
  admission         Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)

  @@map("ipd_vitals")
}

model Treatment {
  id            String          @id @default(cuid())
  admissionId   String
  doctorId      String
  type          TreatmentType
  description   String
  medication    String?
  dosage        String?
  frequency     String?
  route         String?
  startDate     DateTime        @default(now())
  endDate       DateTime?
  status        TreatmentStatus @default(ACTIVE)
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  // Relations
  admission     Admission       @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  doctor        Doctor          @relation(fields: [doctorId], references: [id])

  @@map("treatments")
}

model BedTransfer {
  id            String   @id @default(cuid())
  admissionId   String
  fromBedId     String
  toBedId       String
  transferDate  DateTime @default(now())
  transferTime  String
  reason        String
  approvedBy    String
  notes         String?
  createdAt     DateTime @default(now())
  
  // Relations
  admission     Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  fromBed       Bed       @relation("FromBedTransfer", fields: [fromBedId], references: [id])
  toBed         Bed       @relation("ToBedTransfer", fields: [toBedId], references: [id])

  @@map("bed_transfers")
}

model Discharge {
  id                     String             @id @default(cuid())
  admissionId            String             @unique
  doctorId               String
  dischargeDate          DateTime           @default(now())
  dischargeTime          String
  dischargeType          String             // Normal, LAMA, Death, etc.
  finalDiagnosis         String
  treatmentSummary       String?
  conditionAtDischarge   String?
  followUpInstructions   String?
  followUpDate           DateTime?
  restrictions           String?
  notes                  String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  
  // Relations
  admission              Admission          @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  doctor                 Doctor             @relation(fields: [doctorId], references: [id])
  medications            DischargeMedication[]

  @@map("discharges")
}

model DischargeMedication {
  id           String    @id @default(cuid())
  dischargeId  String
  medicineName String
  dosage       String
  frequency    String
  duration     String
  instructions String?
  createdAt    DateTime  @default(now())
  
  // Relations
  discharge    Discharge @relation(fields: [dischargeId], references: [id], onDelete: Cascade)

  @@map("discharge_medications")
}

// ========================================
// Enhanced Enums for OPD & IPD
// ========================================

enum VisitType {
  OPD
  EMERGENCY
  REVIEW
}

enum AppointmentMode {
  WALK_IN
  ONLINE
  PHONE
}

enum ReferralSource {
  SELF
  DOCTOR
  HOSPITAL
  CLINIC
  OTHER
}

enum VisitPriority {
  NORMAL
  URGENT
  EMERGENCY
}

enum VisitStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MedicineRoute {
  ORAL
  IV
  IM
  SUBCUTANEOUS
  TOPICAL
  INHALATION
  OTHER
}

enum InvestigationUrgency {
  ROUTINE
  URGENT
  STAT
}

enum InvestigationType {
  LAB
  RADIOLOGY
  OTHER
}

enum InvestigationStatus {
  ORDERED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum WardType {
  GENERAL
  ICU
  NICU
  CCU
  EMERGENCY
}

enum AdmissionStatus {
  STABLE
  CRITICAL
  RECOVERY
  DISCHARGED
}

enum AdmissionType {
  EMERGENCY
  ELECTIVE
  REFERRAL
}

enum TreatmentType {
  MEDICATION
  PROCEDURE
  THERAPY
  INVESTIGATION
}

enum TreatmentStatus {
  ACTIVE
  COMPLETED
  DISCONTINUED
}

enum DocumentCategory {
  ADMISSION
  DISCHARGE
  MEDICAL
  INSURANCE
  IDENTIFICATION
  OTHER
}

// Document Management Models
model Document {
  id            String           @id @default(cuid())
  patientId     String
  documentName  String
  filePath      String
  category      DocumentCategory @default(OTHER)
  fileSize      Int?
  mimeType      String?
  notes         String?
  uploadedBy    String?
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  patient       Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("documents")
}
